name: Build Unsigned IPA for TrollStore (iOS 13+ arm64/arm64e)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest'

    - name: Install Tuist via Homebrew
      run: |
        brew update
        brew install tuist
        tuist version

    - name: Generate Project with Tuist (iOS 13.0)
      run: |
        # åœ¨ç”Ÿæˆé¡¹ç›®æ—¶è®¾ç½®éƒ¨ç½²ç›®æ ‡ï¼ˆå¦‚æžœ Tuist æ”¯æŒï¼‰
        # æˆ–è€…é€šè¿‡çŽ¯å¢ƒå˜é‡å½±å“ Tuist çš„ç”Ÿæˆ
        export IPHONEOS_DEPLOYMENT_TARGET=13.0
        tuist generate --no-open
        ls -la *.xcodeproj || echo "æ£€æŸ¥é¡¹ç›®æ–‡ä»¶"

    - name: Build Xcode Archive (arm64/arm64e)
      run: |
        # æ˜Žç¡®æŒ‡å®šé¡¹ç›®åç§°
        PROJECT_NAME="Gudaowebapp"
        SCHEME_NAME="$PROJECT_NAME"
        
        # å…³é”®ä¿®æ”¹ç‚¹ï¼š
        # 1. è®¾ç½®æž„å»º arm64 å’Œ arm64e æž¶æž„
        # 2. è®¾ç½® iOS 13.0 æœ€ä½Žéƒ¨ç½²ç›®æ ‡
        # 3. åŒæ—¶æ”¯æŒæ ‡å‡†å’Œæ‰©å±•æž¶æž„
        xcodebuild clean archive \
          -project "$PROJECT_NAME.xcodeproj" \
          -scheme "$SCHEME_NAME" \
          -configuration Release \
          -archivePath "$PWD/build/$PROJECT_NAME.xcarchive" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          -destination generic/platform=iOS \
          ENABLE_BITCODE=NO \
          ARCHS="arm64 arm64e" \
          ONLY_ACTIVE_ARCH=NO \
          IPHONEOS_DEPLOYMENT_TARGET=13.0 \
          VALID_ARCHS="arm64 arm64e"

    - name: Verify Binary Architecture
      run: |
        # æ˜Žç¡®æŒ‡å®šé¡¹ç›®åç§°
        PROJECT_NAME="Gudaowebapp"
        ARCHIVE_PATH="$PWD/build/$PROJECT_NAME.xcarchive"
        APP_BUNDLE=$(find "$ARCHIVE_PATH/Products/Applications" -name "*.app" -type d | head -1)
        if [ -z "$APP_BUNDLE" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° .app åŒ…"
          exit 1
        fi
        APP_NAME=$(basename "$APP_BUNDLE" .app)
        APP_BINARY="$APP_BUNDLE/$APP_NAME"
        
        echo "ðŸ” éªŒè¯äºŒè¿›åˆ¶æž¶æž„:"
        # æ£€æŸ¥æ˜¯å¦ä¸ºçº¯ arm64 æž¶æž„
        lipo -info "$APP_BINARY"
        # è¯¦ç»†æž¶æž„ä¿¡æ¯
        echo "æž¶æž„è¯¦æƒ…:"
        file "$APP_BINARY"
        # æ£€æŸ¥ Mach-O ä¿¡æ¯
        otool -hv "$APP_BINARY" | head -20

    - name: Package & Fix IPA for TrollStore
      id: package_ipa
      run: |
        # æ˜Žç¡®æŒ‡å®šé¡¹ç›®åç§°
        PROJECT_NAME="Gudaowebapp"
        ARCHIVE_PATH="$PWD/build/$PROJECT_NAME.xcarchive"
        
        # æŸ¥æ‰¾ .app åŒ…
        APP_BUNDLE=$(find "$ARCHIVE_PATH/Products/Applications" -name "*.app" -type d | head -1)
        if [ -z "$APP_BUNDLE" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° .app åŒ…"
          exit 1
        fi
        
        APP_NAME=$(basename "$APP_BUNDLE" .app)
        APP_BINARY="$APP_BUNDLE/$APP_NAME"
        
        echo "å¤„ç†åº”ç”¨: $APP_NAME"
        echo "äºŒè¿›åˆ¶è·¯å¾„: $APP_BINARY"
        
        # æ£€æŸ¥å¹¶ä¿®å¤ Info.plist ä¸­çš„æœ€å°ç‰ˆæœ¬
        INFO_PLIST="$APP_BUNDLE/Info.plist"
        if [ -f "$INFO_PLIST" ]; then
          echo "å½“å‰æœ€å°ç³»ç»Ÿç‰ˆæœ¬:"
          /usr/libexec/PlistBuddy -c "Print :MinimumOSVersion" "$INFO_PLIST" 2>/dev/null || echo "æœªæ‰¾åˆ° MinimumOSVersion é”®"
          
          # è®¾ç½®ä¸º iOS 13.0
          echo "è®¾ç½®æœ€å°ç³»ç»Ÿç‰ˆæœ¬ä¸º 13.0..."
          /usr/libexec/PlistBuddy -c "Set :MinimumOSVersion 13.0" "$INFO_PLIST" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Add :MinimumOSVersion string 13.0" "$INFO_PLIST"
        fi
        
        # å…³é”®ä¿®å¤ 1: ç¡®ä¿å¯æ‰§è¡Œæƒé™
        echo "âž¡ï¸ ä¿®å¤å¯æ‰§è¡Œæƒé™..."
        chmod +x "$APP_BINARY"
        
        # å…³é”®ä¿®å¤ 2: ä¸º TrollStore è¿›è¡Œä¼ªç­¾å
        echo "âž¡ï¸ ä¸º TrollStore æ³¨å…¥æƒé™..."
        brew install ldid
        ldid -S "$APP_BINARY"
        
        # éªŒè¯
        echo "âœ… ä¿®å¤å®Œæˆã€‚æœ€ç»ˆæƒé™ï¼š"
        ls -l "$APP_BINARY"
        
        # æ‰“åŒ…
        IPA_DIR="$PWD/build/ipa"
        mkdir -p "$IPA_DIR/Payload"
        cp -R "$APP_BUNDLE" "$IPA_DIR/Payload/"
        cd "$IPA_DIR"
        IPA_NAME="${PROJECT_NAME}_iOS13_arm64_arm64e_TrollStore.ipa"
        zip -r "../$IPA_NAME" Payload
        
        # è®¾ç½®è¾“å‡ºä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
        echo "ipa_name=$IPA_NAME" >> $GITHUB_OUTPUT

    - name: Upload TrollStore IPA
      uses: actions/upload-artifact@v4
      with:
        name: trollstore-ipa-ios13-arm64-arm64e
        path: ${{ github.workspace }}/build/*_TrollStore.ipa
        retention-days: 7
